{% extends 'clinic/base_layout15.html.twig' %}

{% block title %}{{ client ? 'Modifier' : 'Nouveau' }} client{% endblock %}

{% block page_icon %}<i class="ki-filled ki-{{ client ? 'pencil' : 'plus' }} text-base"></i>{% endblock %}
{% block page_title %}{{ client ? 'Modifier' : 'Nouveau' }} client{% endblock %}

{% block breadcrumbs %}
    <li class="text-muted-foreground">/</li>
    <li>
        <a href="{{ path('clinic_clients_list') }}" class="hover:text-foreground">Clients</a>
    </li>
    <li class="text-muted-foreground">/</li>
    <li class="text-foreground">{{ client ? 'Modifier' : 'Nouveau' }}</li>
{% endblock %}

{% block page_actions %}
    <a href="{{ client ? path('clinic_clients_view', {id: client.id}) : path('clinic_clients_list') }}" class="kt-btn kt-btn-sm kt-btn-light shadow-xs">
        <i class="ki-filled ki-cross text-base"></i>
        <span class="hidden md:inline">Annuler</span>
    </a>
    <button type="submit" form="clientForm" class="kt-btn kt-btn-sm kt-btn-primary shadow-xs">
        <i class="ki-filled ki-save text-base"></i>
        <span class="hidden md:inline">{{ client ? 'Sauvegarder' : 'Créer' }}</span>
    </button>
{% endblock %}

{% block content %}
    <form method="post" action="{{ client ? path('clinic_clients_update', {id: client.id}) : path('clinic_clients_create') }}" id="clientForm">
        <input type="hidden" name="_token" value="{{ csrf_token('clinic_client_form') }}">

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                {# Identity Card #}
                <div class="card card-flush">
                    <div class="card-header">
                        <h3 class="card-title text-base font-semibold">
                            <i class="ki-filled ki-profile-circle me-2"></i>Identité
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="first_name" class="form-label required">Prénom</label>
                                <input type="text"
                                       class="form-control"
                                       id="first_name"
                                       name="first_name"
                                       required
                                       value="{{ client ? client.firstName : '' }}"
                                       placeholder="Prénom du client">
                            </div>
                            <div>
                                <label for="last_name" class="form-label required">Nom</label>
                                <input type="text"
                                       class="form-control"
                                       id="last_name"
                                       name="last_name"
                                       required
                                       value="{{ client ? client.lastName : '' }}"
                                       placeholder="Nom du client">
                            </div>
                        </div>
                    </div>
                </div>

                {# Contact Methods Card #}
                <div class="card card-flush">
                    <div class="card-header">
                        <h3 class="card-title text-base font-semibold">
                            <i class="ki-filled ki-phone me-2"></i>Moyens de contact
                        </h3>
                        <div class="card-toolbar">
                            <button type="button" id="addContactMethod" class="kt-btn kt-btn-sm kt-btn-light">
                                <i class="ki-filled ki-plus"></i>Ajouter
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="space-y-3" id="contactMethodsContainer">
                            {% if client and client.contactMethods|length > 0 %}
                                {% for contact in client.contactMethods %}
                                    {% include 'clinic/clients/_contact_method_row_layout15.html.twig' with {
                                        contact: contact,
                                        index: loop.index0
                                    } %}
                                {% endfor %}
                            {% else %}
                                {# Default empty rows for new client #}
                                {% include 'clinic/clients/_contact_method_row_layout15.html.twig' with {
                                    contact: null,
                                    index: 0
                                } %}
                                {% include 'clinic/clients/_contact_method_row_layout15.html.twig' with {
                                    contact: null,
                                    index: 1
                                } %}
                            {% endif %}
                        </div>
                        <div class="text-xs text-muted-foreground mt-3">
                            <i class="ki-filled ki-information-circle me-1"></i>
                            Au moins un moyen de contact est requis. Cochez "Principal" pour définir le contact principal.
                        </div>
                    </div>
                </div>

                {# Postal Address Card #}
                <div class="card card-flush">
                    <div class="card-header">
                        <h3 class="card-title text-base font-semibold">
                            <i class="ki-filled ki-geolocation me-2"></i>Adresse postale
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="md:col-span-2">
                                <label for="postal_address_street_line_1" class="form-label">Adresse ligne 1</label>
                                <input type="text"
                                       class="form-control"
                                       id="postal_address_street_line_1"
                                       name="postal_address_street_line_1"
                                       value="{{ client.postalAddress.streetLine1 ?? '' }}"
                                       placeholder="Numéro et rue">
                            </div>
                            <div class="md:col-span-2">
                                <label for="postal_address_street_line_2" class="form-label">Adresse ligne 2</label>
                                <input type="text"
                                       class="form-control"
                                       id="postal_address_street_line_2"
                                       name="postal_address_street_line_2"
                                       value="{{ client.postalAddress.streetLine2 ?? '' }}"
                                       placeholder="Bâtiment, appartement, etc.">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="postal_address_postal_code" class="form-label">Code postal</label>
                                <input type="text"
                                       class="form-control"
                                       id="postal_address_postal_code"
                                       name="postal_address_postal_code"
                                       value="{{ client.postalAddress.postalCode ?? '' }}"
                                       placeholder="75001">
                            </div>
                            <div>
                                <label for="postal_address_city" class="form-label">Ville</label>
                                <input type="text"
                                       class="form-control"
                                       id="postal_address_city"
                                       name="postal_address_city"
                                       value="{{ client.postalAddress.city ?? '' }}"
                                       placeholder="Paris">
                            </div>
                            <div>
                                <label for="postal_address_region" class="form-label">Région</label>
                                <input type="text"
                                       class="form-control"
                                       id="postal_address_region"
                                       name="postal_address_region"
                                       value="{{ client.postalAddress.region ?? '' }}"
                                       placeholder="Île-de-France">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="postal_address_country_code" class="form-label">Code pays</label>
                                <input type="text"
                                       class="form-control"
                                       id="postal_address_country_code"
                                       name="postal_address_country_code"
                                       value="{{ client.postalAddress.countryCode ?? '' }}"
                                       placeholder="FR"
                                       maxlength="2">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1">
                {# Help Card #}
                <div class="card card-flush bg-muted/40">
                    <div class="card-header">
                        <h3 class="card-title text-base font-semibold">
                            <i class="ki-filled ki-information-circle me-2"></i>Aide
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="space-y-4 text-sm">
                            <div>
                                <h4 class="font-semibold mb-1">Identité</h4>
                                <p class="text-muted-foreground text-xs">
                                    Le prénom et le nom du client sont obligatoires.
                                </p>
                            </div>
                            <div class="kt-separator"></div>
                            <div>
                                <h4 class="font-semibold mb-1">Moyens de contact</h4>
                                <p class="text-muted-foreground text-xs">
                                    Au moins un moyen de contact (téléphone ou email) est requis. 
                                    Vous pouvez définir un contact principal pour chaque type.
                                </p>
                            </div>
                            <div class="kt-separator"></div>
                            <div>
                                <h4 class="font-semibold mb-1">Adresse postale</h4>
                                <p class="text-muted-foreground text-xs">
                                    L'adresse postale est optionnelle mais peut être utile pour l'envoi de documents.
                                    Le code pays doit être au format ISO 3166-1 alpha-2 (ex: FR, BE, CH).
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                {# Status Card (only for edit) #}
                {% if client %}
                    <div class="card card-flush bg-muted/40 mt-6">
                        <div class="card-header">
                            <h3 class="card-title text-base font-semibold">
                                <i class="ki-filled ki-information me-2"></i>Informations
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-muted-foreground">Statut:</span>
                                    {% if client.status == 'active' %}
                                        <span class="kt-badge kt-badge-light kt-badge-success">Actif</span>
                                    {% else %}
                                        <span class="kt-badge kt-badge-light kt-badge-secondary">Archivé</span>
                                    {% endif %}
                                </div>
                                <div class="kt-separator"></div>
                                <div class="flex justify-between">
                                    <span class="text-muted-foreground">Créé le:</span>
                                    <span class="font-mono text-xs">{{ client.createdAt|date('d/m/Y H:i') }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-muted-foreground">Modifié le:</span>
                                    <span class="font-mono text-xs">{{ client.updatedAt|date('d/m/Y H:i') }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        {# Form Actions (Bottom) #}
        <div class="flex justify-end gap-3 mt-6">
            <a href="{{ client ? path('clinic_clients_view', {id: client.id}) : path('clinic_clients_list') }}" class="kt-btn kt-btn-light">
                <i class="ki-filled ki-cross text-base"></i>
                Annuler
            </a>
            <button type="submit" class="kt-btn kt-btn-primary">
                <i class="ki-filled ki-save text-base"></i>
                {{ client ? 'Sauvegarder les modifications' : 'Créer le client' }}
            </button>
        </div>
    </form>
{% endblock %}

{% set contactMethodRowTemplate %}
    {% include 'clinic/clients/_contact_method_row_layout15.html.twig' with {
        contact: null,
        index: 'NEW_INDEX'
    } only %}
{% endset %}

{% block javascripts %}
    {{ parent() }}
    <script data-turbo-temporary>
        document.addEventListener('turbo:load', function() {
            let contactMethodIndex = {{ client ? client.contactMethods|length : 2 }};
            const addContactMethodButton = document.getElementById('addContactMethod');
            const contactMethodsContainer = document.getElementById('contactMethodsContainer');

            if (!addContactMethodButton || !contactMethodsContainer) {
                return;
            }

            const newAddContactMethodButton = addContactMethodButton.cloneNode(true);
            addContactMethodButton.replaceWith(newAddContactMethodButton);

            const newContactMethodsContainer = contactMethodsContainer.cloneNode(true);
            contactMethodsContainer.replaceWith(newContactMethodsContainer);

            newAddContactMethodButton.addEventListener('click', function() {
                const template = {{ contactMethodRowTemplate|e('js') }};
                newContactMethodsContainer.insertAdjacentHTML('beforeend', template.replace(/NEW_INDEX/g, contactMethodIndex));
                contactMethodIndex++;
            });

            newContactMethodsContainer.addEventListener('click', function(e) {
                if (e.target.closest('.remove-contact')) {
                    const row = e.target.closest('.contact-method-row');
                    if (newContactMethodsContainer.querySelectorAll('.contact-method-row').length > 1) {
                        row.remove();
                    } else {
                        alert('Au moins un moyen de contact est requis.');
                    }
                }
            });
        });
    </script>
{% endblock %}
